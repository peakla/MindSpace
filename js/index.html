<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MindBalance | Blog</title>

  <!-- Metadata -->
  <link rel="icon" type="image/png" href="../assets/images/favicon.png" />
  <meta name="title" content="MindBalance - Mental Health Blog & Resource Hub" />
  <meta name="description"
    content="MindBalance is a curated mental health blog featuring credible resources, clear explanations, and practical takeaways on anxiety, stress, depression, sleep, mindfulness, and teen mental health." />

  <!-- Performance: CDN loads -->
  <link rel="preconnect" href="https://unpkg.com" />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

  <!-- Stylesheets -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper/swiper-bundle.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <!-- CSS -->
  <link rel="stylesheet" href="../css/style.css" />

  <!-- Preload -->
  <link rel="preload" href="../css/style.css" as="style" />

  <!-- Webflow-like JS -->
  <script>
    !function (o, c) {
      var n = c.documentElement, t = " w-mod-";
      n.className += t + "js";
      ("ontouchstart" in o || (o.DocumentTouch && c instanceof DocumentTouch)) &&
        (n.className += t + "touch");
    }(window, document);
  </script>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>

  <style>
    /* Minimal, isolated styling so it doesn't fight your theme */
    .mb-wrap { max-width: 1180px; margin: 0 auto; padding: 24px 16px; }
    .mb-grid { display: grid; grid-template-columns: 280px 1fr 320px; gap: 18px; align-items: start; }
    @media (max-width: 1060px){ .mb-grid{ grid-template-columns: 1fr; } }

    .mb-card{
      background: #fff;
      border: 1px solid rgba(0,0,0,.08);
      border-radius: 16px;
      box-shadow: 0 10px 28px rgba(0,0,0,.05);
      overflow: hidden;
    }
    .mb-card__head{ padding: 14px 14px 10px; border-bottom: 1px solid rgba(0,0,0,.06); }
    .mb-card__body{ padding: 14px; }
    .mb-title{ font-size: 18px; margin: 0; }
    .mb-sub{ margin: 6px 0 0; opacity: .75; font-size: 13px; line-height: 1.35; }

    .mb-btn{
      display: inline-flex; align-items: center; justify-content: center;
      gap: 8px;
      padding: 10px 12px;
      border: 0;
      border-radius: 12px;
      background: #111;
      color: #fff;
      font-weight: 700;
      cursor: pointer;
      text-decoration: none;
      user-select: none;
    }
    .mb-btn:hover{ opacity: .93; }
    .mb-btn--ghost{
      background: rgba(0,0,0,.06);
      color: #111;
      border: 1px solid rgba(0,0,0,.08);
    }
    .mb-btn--danger{
      background: rgba(220, 38, 38, .1);
      color: #b91c1c;
      border: 1px solid rgba(220,38,38,.25);
    }

    .mb-pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px; border-radius: 999px;
      background: rgba(0,0,0,.06);
      font-size: 12px; font-weight: 700;
    }

    .mb-row{ display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
    .mb-col{ display:flex; flex-direction: column; gap: 10px; }

    .mb-input, .mb-textarea, .mb-select{
      width: 100%;
      border: 1px solid rgba(0,0,0,.15);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 14px;
      outline: none;
      background: #fff;
    }
    .mb-textarea{ min-height: 86px; resize: vertical; }
    .mb-select{ cursor: pointer; }

    .mb-feed{ display:flex; flex-direction: column; gap: 14px; }
    .mb-post{ padding: 14px; }
    .mb-post__top{ display:flex; justify-content: space-between; gap: 10px; }
    .mb-post__meta{ display:flex; flex-direction: column; gap: 2px; }
    .mb-post__name{ font-weight: 800; font-size: 14px; }
    .mb-post__time{ font-size: 12px; opacity: .7; }
    .mb-post__cat{ margin-top: 6px; }
    .mb-post__content{ margin: 10px 0 0; line-height: 1.45; white-space: pre-wrap; }
    .mb-post__link{ margin-top: 8px; display:inline-block; font-weight: 700; }
    .mb-post__actions{ margin-top: 12px; display:flex; gap: 10px; flex-wrap: wrap; }
    .mb-action{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,.10);
      background: #fff;
      cursor: pointer;
      font-weight: 800;
      font-size: 13px;
    }
    .mb-action.is-active{
      background: rgba(0,0,0,.06);
      border-color: rgba(0,0,0,.18);
    }

    .mb-comments{ margin-top: 12px; border-top: 1px solid rgba(0,0,0,.06); padding-top: 12px; display:none; }
    .mb-comment{ padding: 10px 10px; border: 1px solid rgba(0,0,0,.08); border-radius: 12px; background: rgba(0,0,0,.02); }
    .mb-comment__meta{ display:flex; justify-content: space-between; gap: 10px; font-size: 12px; opacity: .75; }
    .mb-comment__text{ margin-top: 6px; white-space: pre-wrap; line-height: 1.45; }

    .mb-toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(17,17,17,.92);
      color: #fff;
      font-weight: 800;
      font-size: 13px;
      opacity: 0;
      pointer-events: none;
      transition: opacity .2s ease;
      z-index: 9999;
      max-width: 92vw;
      text-align: center;
    }
    .mb-toast.is-show{ opacity: 1; }
    .mb-muted{ opacity: .75; }
  </style>
</head>

<body>
  <!-- You can keep your existing header/nav; this page is standalone and won't break it. -->

  <div class="mb-wrap">
    <div class="mb-grid">

      <!-- LEFT COLUMN -->
      <aside class="mb-col">
        <div class="mb-card">
          <div class="mb-card__head">
            <h2 class="mb-title">Community Hub</h2>
            <p class="mb-sub">Share updates, ask questions, and discuss resources respectfully.</p>
          </div>
          <div class="mb-card__body" id="sessionBox">
            <!-- Filled by JS -->
          </div>
        </div>

        <div class="mb-card">
          <div class="mb-card__head">
            <h3 class="mb-title" style="font-size:16px;">Guidelines</h3>
          </div>
          <div class="mb-card__body">
            <div class="mb-col" style="gap:8px;">
              <div class="mb-pill">Be respectful</div>
              <div class="mb-pill">No harassment</div>
              <div class="mb-pill">No personal medical claims</div>
              <div class="mb-pill">Encourage professional help</div>
              <p class="mb-sub">
                This is not medical advice. If someone is in danger or needs urgent help, use local emergency services.
              </p>
            </div>
          </div>
        </div>
      </aside>

      <!-- CENTER COLUMN -->
      <main class="mb-col">
        <!-- COMPOSER -->
        <div class="mb-card" id="composerCard">
          <div class="mb-card__head">
            <h3 class="mb-title" style="font-size:16px;">Activity Feed</h3>
            <p class="mb-sub">Post an update, share a resource link, or ask a question.</p>
          </div>
          <div class="mb-card__body" id="composerBody">
            <!-- Filled by JS -->
          </div>
        </div>

        <!-- FEED -->
        <div class="mb-card">
          <div class="mb-card__head">
            <div class="mb-row" style="justify-content: space-between;">
              <div>
                <h3 class="mb-title" style="font-size:16px;">Latest posts</h3>
                <p class="mb-sub" id="feedStatus">Loading‚Ä¶</p>
              </div>
              <button class="mb-btn mb-btn--ghost" id="refreshBtn" type="button">Refresh</button>
            </div>
          </div>

          <div class="mb-card__body">
            <div class="mb-feed" id="feed"></div>

            <div class="mb-row" style="justify-content:center; margin-top: 14px;">
              <button class="mb-btn mb-btn--ghost" id="loadMoreBtn" type="button">Load more</button>
            </div>
          </div>
        </div>
      </main>

      <!-- RIGHT COLUMN -->
      <aside class="mb-col">
        <div class="mb-card">
          <div class="mb-card__head">
            <h3 class="mb-title" style="font-size:16px;">Quick Links</h3>
          </div>
          <div class="mb-card__body">
            <div class="mb-col">
              <a class="mb-btn mb-btn--ghost" href="../blog/">Go to Blog</a>
              <a class="mb-btn mb-btn--ghost" href="../resourcelib/">Resource Library</a>
              <a class="mb-btn mb-btn--ghost" href="../auth/?returnTo=/community/">Sign in / Register</a>
            </div>
            <p class="mb-sub" style="margin-top:10px;">
              Signed-in users can post, comment, and like. Guests can browse.
            </p>
          </div>
        </div>

        <div class="mb-card">
          <div class="mb-card__head">
            <h3 class="mb-title" style="font-size:16px;">Categories</h3>
          </div>
          <div class="mb-card__body">
            <div class="mb-col" style="gap:8px;">
              <button class="mb-btn mb-btn--ghost" type="button" data-cat="all">All</button>
              <button class="mb-btn mb-btn--ghost" type="button" data-cat="General">General</button>
              <button class="mb-btn mb-btn--ghost" type="button" data-cat="Anxiety">Anxiety</button>
              <button class="mb-btn mb-btn--ghost" type="button" data-cat="Stress">Stress</button>
              <button class="mb-btn mb-btn--ghost" type="button" data-cat="Sleep">Sleep</button>
              <button class="mb-btn mb-btn--ghost" type="button" data-cat="Mindfulness">Mindfulness</button>
              <button class="mb-btn mb-btn--ghost" type="button" data-cat="Teens">Teens</button>
            </div>
            <p class="mb-sub" style="margin-top:10px;" id="activeCategoryLabel">Filter: All</p>
          </div>
        </div>
      </aside>

    </div>
  </div>

  <div class="mb-toast" id="toast" role="status" aria-live="polite" aria-atomic="true"></div>

  <script>
    /***********************
     * 1) SUPABASE CONFIG
     ***********************/
    const SUPABASE_URL = "https://cxjqessxarjayqxvhnhs.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN4anFlc3N4YXJqYXlxeHZobmhzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwMjQwOTEsImV4cCI6MjA4MzYwMDA5MX0.SUI4sPOSPxDiGwqwQr19UOKtbK7KmjMqkX6HUT6-yps";
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /***********************
     * 2) UI HELPERS
     ***********************/
    const toast = document.getElementById("toast");
    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add("is-show");
      clearTimeout(toast._t);
      toast._t = setTimeout(()=>toast.classList.remove("is-show"), 1800);
    }

    function formatTime(iso){
      try{
        const d = new Date(iso);
        return d.toLocaleString(undefined, { month:"short", day:"numeric", year:"numeric", hour:"numeric", minute:"2-digit" });
      }catch{ return ""; }
    }

    function safeLink(url){
      if(!url) return "";
      const u = url.trim();
      if(!u) return "";
      if(u.startsWith("http://") || u.startsWith("https://")) return u;
      return "https://" + u;
    }

    /***********************
     * 3) STATE
     ***********************/
    let sessionUser = null;
    let displayName = null;
    let activeCategory = "all";

    let pageSize = 10;
    let pageOffset = 0;
    let latestPostsCache = []; // keep last fetched posts to reuse
    const feedEl = document.getElementById("feed");
    const feedStatusEl = document.getElementById("feedStatus");
    const sessionBox = document.getElementById("sessionBox");
    const composerBody = document.getElementById("composerBody");
    const activeCategoryLabel = document.getElementById("activeCategoryLabel");

    /***********************
     * 4) SESSION + PROFILE
     ***********************/
    async function loadSession(){
      const { data } = await sb.auth.getSession();
      sessionUser = data?.session?.user || null;

      if(sessionUser){
        // Try pull profile display name
        const { data: prof } = await sb
          .from("profiles")
          .select("display_name")
          .eq("id", sessionUser.id)
          .maybeSingle();

        displayName = prof?.display_name || sessionUser.email?.split("@")[0] || "Member";
      }else{
        displayName = null;
      }

      renderSessionBox();
      renderComposer();
    }

    function renderSessionBox(){
      if(sessionUser){
        sessionBox.innerHTML = `
          <div class="mb-col">
            <div class="mb-row" style="justify-content: space-between;">
              <div>
                <div style="font-weight:900;">Signed in</div>
                <div class="mb-sub" style="margin-top:4px;">${sessionUser.email}</div>
              </div>
              <span class="mb-pill">Active</span>
            </div>

            <div class="mb-row" style="margin-top:10px;">
              <a class="mb-btn mb-btn--ghost" href="../blog/">Blog</a>
              <button class="mb-btn mb-btn--danger" id="signOutBtn" type="button">Sign out</button>
            </div>

            <p class="mb-sub">You can post, comment, and like.</p>
          </div>
        `;

        document.getElementById("signOutBtn").addEventListener("click", async ()=>{
          await sb.auth.signOut();
          showToast("Signed out.");
          await loadSession();
          await refreshFeed(true);
        });
      }else{
        sessionBox.innerHTML = `
          <div class="mb-col">
            <div class="mb-row" style="justify-content: space-between;">
              <div>
                <div style="font-weight:900;">Guest</div>
                <div class="mb-sub" style="margin-top:4px;">Browsing only</div>
              </div>
              <span class="mb-pill">Read-only</span>
            </div>

            <a class="mb-btn" href="../auth/?returnTo=/community/">Sign in / Register</a>

            <p class="mb-sub">Sign in to post, like, and comment.</p>
          </div>
        `;
      }
    }

    function renderComposer(){
      if(!sessionUser){
        composerBody.innerHTML = `
          <div class="mb-col">
            <p class="mb-sub" style="margin:0;">
              Sign in to create posts and join the discussion.
            </p>
            <a class="mb-btn" href="../auth/?returnTo=/community/">Sign in to post</a>
          </div>
        `;
        return;
      }

      composerBody.innerHTML = `
        <div class="mb-col">
          <div class="mb-row">
            <select class="mb-select" id="postCategory" aria-label="Post category" style="max-width:220px;">
              <option>General</option>
              <option>Anxiety</option>
              <option>Stress</option>
              <option>Depression</option>
              <option>Sleep</option>
              <option>Mindfulness</option>
              <option>Teens</option>
              <option>Resources</option>
            </select>
            <span class="mb-pill">Posting as: ${displayName}</span>
          </div>

          <textarea class="mb-textarea" id="postContent" placeholder="Share an update, ask a question, or reflect on a resource‚Ä¶"></textarea>

          <input class="mb-input" id="postLink" type="url" placeholder="Optional link (ex: https://www.cdc.gov/mentalhealth/learn/)" />

          <div class="mb-row" style="justify-content: space-between;">
            <div class="mb-sub mb-muted">Keep it respectful and supportive.</div>
            <button class="mb-btn" id="postBtn" type="button">Post</button>
          </div>
        </div>
      `;

      document.getElementById("postBtn").addEventListener("click", createPost);
    }

    /***********************
     * 5) DATA LOADERS
     ***********************/
    async function fetchPosts({ reset=false } = {}){
      if(reset){
        pageOffset = 0;
        latestPostsCache = [];
      }

      let q = sb.from("community_posts")
        .select("id, author_id, author_name, category, content, link_url, created_at")
        .order("created_at", { ascending: false })
        .range(pageOffset, pageOffset + pageSize - 1);

      if(activeCategory !== "all"){
        q = q.eq("category", activeCategory);
      }

      const { data, error } = await q;
      if(error) throw error;

      // Update paging
      pageOffset += pageSize;
      latestPostsCache = reset ? (data || []) : latestPostsCache.concat(data || []);

      return data || [];
    }

    async function fetchCountsAndUserLikes(postIds){
      // Likes
      const { data: likesData, error: likesErr } = await sb
        .from("community_likes")
        .select("post_id, user_id")
        .in("post_id", postIds);

      if(likesErr) throw likesErr;

      // Comments
      const { data: commentsData, error: commentsErr } = await sb
        .from("community_comments")
        .select("post_id")
        .in("post_id", postIds);

      if(commentsErr) throw commentsErr;

      const likeCounts = {};
      const commentCounts = {};

      for(const row of (likesData || [])){
        likeCounts[row.post_id] = (likeCounts[row.post_id] || 0) + 1;
      }
      for(const row of (commentsData || [])){
        commentCounts[row.post_id] = (commentCounts[row.post_id] || 0) + 1;
      }

      const userLiked = {};
      if(sessionUser){
        for(const row of (likesData || [])){
          if(row.user_id === sessionUser.id){
            userLiked[row.post_id] = true;
          }
        }
      }

      return { likeCounts, commentCounts, userLiked };
    }

    async function fetchComments(postId){
      const { data, error } = await sb
        .from("community_comments")
        .select("id, author_id, author_name, content, created_at")
        .eq("post_id", postId)
        .order("created_at", { ascending: true })
        .limit(50);

      if(error) throw error;
      return data || [];
    }

    /***********************
     * 6) RENDER FEED
     ***********************/
    function renderPosts(posts, metaById){
      const { likeCounts, commentCounts, userLiked } = metaById;

      for(const p of posts){
        const likeCount = likeCounts[p.id] || 0;
        const commentCount = commentCounts[p.id] || 0;
        const liked = !!userLiked[p.id];

        const link = safeLink(p.link_url);
        const canDelete = sessionUser && sessionUser.id === p.author_id;

        const el = document.createElement("div");
        el.className = "mb-post mb-card";
        el.setAttribute("data-post-id", p.id);

        el.innerHTML = `
          <div class="mb-post__top">
            <div class="mb-post__meta">
              <div class="mb-post__name">${p.author_name}</div>
              <div class="mb-post__time">${formatTime(p.created_at)}</div>
              <div class="mb-post__cat"><span class="mb-pill">${p.category}</span></div>
            </div>

            <div class="mb-row">
              ${canDelete ? `<button class="mb-action mb-btn--danger" data-action="delete">Delete</button>` : ``}
            </div>
          </div>

          <div class="mb-post__content">${p.content}</div>
          ${link ? `<a class="mb-post__link" href="${link}" target="_blank" rel="noopener">Open link ‚Üí</a>` : ``}

          <div class="mb-post__actions">
            <button class="mb-action ${liked ? "is-active" : ""}" data-action="like">
              ‚ù§Ô∏è <span data-like-count>${likeCount}</span>
            </button>

            <button class="mb-action" data-action="toggle-comments">
              üí¨ <span data-comment-count>${commentCount}</span> Comments
            </button>

            ${sessionUser ? `` : `<span class="mb-sub">Sign in to like or comment.</span>`}
          </div>

          <div class="mb-comments" data-comments-wrap>
            <div class="mb-col" data-comments-list style="gap:10px;"></div>

            ${sessionUser ? `
              <div class="mb-col" style="margin-top:10px; gap:10px;">
                <textarea class="mb-textarea" data-comment-input placeholder="Write a supportive comment‚Ä¶"></textarea>
                <div class="mb-row" style="justify-content:flex-end;">
                  <button class="mb-btn mb-btn--ghost" data-action="add-comment">Add comment</button>
                </div>
              </div>
            ` : `
              <div style="margin-top:10px;">
                <a class="mb-btn" href="../auth/?returnTo=/community/">Sign in to comment</a>
              </div>
            `}
          </div>
        `;

        // Bind actions
        el.addEventListener("click", async (e)=>{
          const btn = e.target.closest("[data-action]");
          if(!btn) return;

          const action = btn.getAttribute("data-action");
          const postId = p.id;

          try{
            if(action === "like"){
              if(!sessionUser){
                showToast("Sign in to like posts.");
                return;
              }
              await toggleLike(postId, btn);
            }

            if(action === "toggle-comments"){
              await toggleComments(el, postId);
            }

            if(action === "add-comment"){
              if(!sessionUser){
                showToast("Sign in to comment.");
                return;
              }
              await addComment(el, postId);
            }

            if(action === "delete"){
              await deletePost(postId);
            }
          }catch(err){
            showToast(err?.message || "Something went wrong.");
            console.error(err);
          }
        });

        feedEl.appendChild(el);
      }
    }

    /***********************
     * 7) ACTIONS (POST/LIKE/COMMENT)
     ***********************/
    async function createPost(){
      const cat = document.getElementById("postCategory").value;
      const content = document.getElementById("postContent").value.trim();
      const link = document.getElementById("postLink").value.trim();

      if(!content){
        showToast("Write something first.");
        return;
      }

      const payload = {
        author_id: sessionUser.id,
        author_name: displayName || "Member",
        category: cat,
        content,
        link_url: link || null
      };

      const { error } = await sb.from("community_posts").insert(payload);
      if(error) throw error;

      document.getElementById("postContent").value = "";
      document.getElementById("postLink").value = "";

      showToast("Posted!");
      await refreshFeed(true);
    }

    async function toggleLike(postId, btn){
      const liked = btn.classList.contains("is-active");

      if(liked){
        const { error } = await sb.from("community_likes")
          .delete()
          .eq("post_id", postId)
          .eq("user_id", sessionUser.id);
        if(error) throw error;

        btn.classList.remove("is-active");
        const countEl = btn.querySelector("[data-like-count]");
        countEl.textContent = Math.max(0, (parseInt(countEl.textContent,10)||0) - 1);
        showToast("Unliked.");
      }else{
        const { error } = await sb.from("community_likes").insert({
          post_id: postId,
          user_id: sessionUser.id
        });
        if(error) throw error;

        btn.classList.add("is-active");
        const countEl = btn.querySelector("[data-like-count]");
        countEl.textContent = (parseInt(countEl.textContent,10)||0) + 1;
        showToast("Liked!");
      }
    }

    async function toggleComments(postEl, postId){
      const wrap = postEl.querySelector("[data-comments-wrap]");
      const list = postEl.querySelector("[data-comments-list]");

      const open = wrap.style.display === "block";
      if(open){
        wrap.style.display = "none";
        return;
      }

      wrap.style.display = "block";
      list.innerHTML = `<div class="mb-sub">Loading comments‚Ä¶</div>`;

      const comments = await fetchComments(postId);
      if(comments.length === 0){
        list.innerHTML = `<div class="mb-sub">No comments yet. Be the first to reply.</div>`;
        return;
      }

      list.innerHTML = "";
      for(const c of comments){
        const cEl = document.createElement("div");
        cEl.className = "mb-comment";
        cEl.innerHTML = `
          <div class="mb-comment__meta">
            <div><strong>${c.author_name}</strong></div>
            <div>${formatTime(c.created_at)}</div>
          </div>
          <div class="mb-comment__text">${c.content}</div>
        `;
        list.appendChild(cEl);
      }
    }

    async function addComment(postEl, postId){
      const input = postEl.querySelector("[data-comment-input]");
      const txt = (input.value || "").trim();
      if(!txt){
        showToast("Write a comment first.");
        return;
      }

      const { error } = await sb.from("community_comments").insert({
        post_id: postId,
        author_id: sessionUser.id,
        author_name: displayName || "Member",
        content: txt
      });
      if(error) throw error;

      input.value = "";
      showToast("Comment added.");

      // Update comment count in UI
      const countEl = postEl.querySelector("[data-comment-count]");
      countEl.textContent = (parseInt(countEl.textContent,10)||0) + 1;

      // Refresh comment list if open
      await toggleComments(postEl, postId);
      await toggleComments(postEl, postId); // open it again with fresh data
    }

    async function deletePost(postId){
      if(!sessionUser) return;
      const ok = confirm("Delete this post? This cannot be undone.");
      if(!ok) return;

      const { error } = await sb.from("community_posts")
        .delete()
        .eq("id", postId)
        .eq("author_id", sessionUser.id);

      if(error) throw error;

      showToast("Deleted.");
      await refreshFeed(true);
    }

    /***********************
     * 8) MAIN FEED FLOW
     ***********************/
    async function refreshFeed(reset=false){
      try{
        feedStatusEl.textContent = "Loading‚Ä¶";
        document.getElementById("loadMoreBtn").disabled = true;

        if(reset){
          feedEl.innerHTML = "";
        }

        const posts = await fetchPosts({ reset });

        if(posts.length === 0 && reset){
          feedStatusEl.textContent = "No posts yet. Be the first to share an update.";
          document.getElementById("loadMoreBtn").style.display = "none";
          return;
        }

        const postIds = posts.map(p=>p.id);
        const meta = await fetchCountsAndUserLikes(postIds);

        renderPosts(posts, meta);

        feedStatusEl.textContent = `Showing ${latestPostsCache.length} posts`;
        document.getElementById("loadMoreBtn").disabled = false;
        document.getElementById("loadMoreBtn").style.display = posts.length < pageSize ? "none" : "inline-flex";
      }catch(err){
        console.error(err);
        feedStatusEl.textContent = "Could not load posts (check Supabase policies / tables).";
        showToast(err?.message || "Failed to load.");
        document.getElementById("loadMoreBtn").disabled = false;
      }
    }

    /***********************
     * 9) CATEGORY FILTER
     ***********************/
    function setCategory(cat){
      activeCategory = cat;
      activeCategoryLabel.textContent = `Filter: ${cat === "all" ? "All" : cat}`;
      refreshFeed(true);
    }

    document.querySelectorAll("[data-cat]").forEach(btn=>{
      btn.addEventListener("click", ()=> setCategory(btn.getAttribute("data-cat")));
    });

    document.getElementById("refreshBtn").addEventListener("click", ()=> refreshFeed(true));
    document.getElementById("loadMoreBtn").addEventListener("click", ()=> refreshFeed(false));

    /***********************
     * 10) STARTUP
     ***********************/
    sb.auth.onAuthStateChange(async ()=>{
      await loadSession();
      await refreshFeed(true);
    });

    (async function init(){
      await loadSession();
      await refreshFeed(true);
    })();
  </script>
</body>
</html>
